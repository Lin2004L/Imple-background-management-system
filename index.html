<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®€æ˜“åå°ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="./assets/style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.prod.js"></script>
  
</head>
<body>
  <!--
    ä¸ºé¿å…ç›´æ¥ç”¨æ–‡ä»¶åè®®(file://)æ‰“å¼€æ—¶å‡ºç°æ¨¡å—è„šæœ¬çš„è·¨åŸŸé™åˆ¶ï¼Œ
    è¿™é‡Œå°†æ‰€æœ‰åº”ç”¨ä»£ç å†…è”åˆ°ä¸€ä¸ªéæ¨¡å—è„šæœ¬ä¸­ï¼Œç¡®ä¿åŒå‡» index.html å³å¯è¿è¡Œã€‚
    è¯¦ç»†æ³¨é‡Šå¸®åŠ©åˆå­¦è€…ç†è§£å„éƒ¨åˆ†çš„ä½œç”¨ã€‚
  -->
  <div id="app"></div>
  <script>
    // ========== å…¨å±€â€œæœåŠ¡å±‚â€ï¼šæ¨¡æ‹Ÿåç«¯APIï¼ˆlocalStorageæŒä¹…åŒ–ï¼‰ ==========
    // ä½¿ç”¨ localStorage å­˜å‚¨ç”¨æˆ·ã€äº§å“ã€é»˜è®¤è´¦å·ä¿¡æ¯ï¼Œå¹¶æä¾› CRUD ä¸ç»Ÿè®¡æ–¹æ³•
    (function(){
      const KEY_USERS = "demo_users";
      const KEY_PRODUCTS = "demo_products";
      const KEY_AUTH = "demo_auth";
      function init() {
        if (!localStorage.getItem(KEY_USERS)) {
          localStorage.setItem(KEY_USERS, JSON.stringify([
            { id: 1, name: "å¼ ä¸‰", email: "zhangsan@example.com", role: "ç®¡ç†å‘˜", status: "åœ¨èŒ" },
            { id: 2, name: "æå››", email: "lisi@example.com", role: "å®¢æœ", status: "åœ¨èŒ" },
            { id: 3, name: "ç‹äº”", email: "wangwu@example.com", role: "è¿è¥", status: "ç¦»èŒ" }
          ]));
        }
        if (!localStorage.getItem(KEY_PRODUCTS)) {
          localStorage.setItem(KEY_PRODUCTS, JSON.stringify([
            { id: 1001, name: "åŸºç¡€ä¼šå‘˜", price: 99, stock: 100, status: "ä¸Šæ¶" },
            { id: 1002, name: "é«˜çº§ä¼šå‘˜", price: 199, stock: 50, status: "ä¸Šæ¶" },
            { id: 1003, name: "ä¸“ä¸šç‰ˆ", price: 299, stock: 10, status: "ä¸‹æ¶" }
          ]));
        }
        if (!localStorage.getItem(KEY_AUTH)) {
          localStorage.setItem(KEY_AUTH, JSON.stringify({ username: "admin", password: "123456", name: "ç®¡ç†å‘˜" }));
        }
      }
      function read(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }
      function write(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
      function listUsers(){ return read(KEY_USERS); }
      function addUser(payload){
        const users = read(KEY_USERS);
        const id = users.length ? Math.max(...users.map(x => x.id)) + 1 : 1;
        const u = { id, ...payload }; users.push(u); write(KEY_USERS, users); return u;
      }
      function updateUser(id, payload){
        const users = read(KEY_USERS);
        const idx = users.findIndex(x => x.id === id);
        if (idx === -1) return null;
        users[idx] = { ...users[idx], ...payload }; write(KEY_USERS, users); return users[idx];
      }
      function deleteUser(id){ write(KEY_USERS, read(KEY_USERS).filter(x => x.id !== id)); }
      function listProducts(){ return read(KEY_PRODUCTS); }
      function addProduct(payload){
        const products = read(KEY_PRODUCTS);
        const id = products.length ? Math.max(...products.map(x => x.id)) + 1 : 1000;
        const p = { id, ...payload }; products.push(p); write(KEY_PRODUCTS, products); return p;
      }
      function updateProduct(id, payload){
        const products = read(KEY_PRODUCTS);
        const idx = products.findIndex(x => x.id === id);
        if (idx === -1) return null;
        products[idx] = { ...products[idx], ...payload }; write(KEY_PRODUCTS, products); return products[idx];
      }
      function deleteProduct(id){ write(KEY_PRODUCTS, read(KEY_PRODUCTS).filter(x => x.id !== id)); }
      function login({ username, password }){
        const auth = JSON.parse(localStorage.getItem(KEY_AUTH) || "{}");
        if (auth.username === username && auth.password === password) return { name: auth.name, username };
        return null;
      }
      function stats(){
        const users = listUsers();
        const products = listProducts();
        const activeUsers = users.filter(x => x.status === "åœ¨èŒ").length;
        const onSale = products.filter(x => x.status === "ä¸Šæ¶").length;
        const revenue = products.reduce((s, p) => s + p.price * Math.max(0, p.stock > 20 ? 20 : p.stock), 0);
        return { users: users.length, products: products.length, activeUsers, onSale, revenue };
      }
      init();
      // æš´éœ²åˆ°å…¨å±€ä»¥ä¾¿å„ç»„ä»¶è°ƒç”¨
      window.api = { listUsers, addUser, updateUser, deleteUser, listProducts, addProduct, updateProduct, deleteProduct, login, stats };
    })();

    // ========== å…¨å±€â€œçŠ¶æ€å±‚â€ï¼šå­˜å‚¨å½“å‰ç™»å½•ç”¨æˆ·ç­‰ ==========
    (function(){
      const currentUser = Vue.ref(null);   // å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆnullè¡¨ç¤ºæœªç™»å½•ï¼‰
      const collapsed = Vue.ref(false);    // ä¾§è¾¹æ æŠ˜å ç¤ºä¾‹ï¼ˆå¯æ‰©å±•ï¼‰
      function login(user){ currentUser.value = user; }
      function logout(){ currentUser.value = null; }
      window.store = { currentUser, collapsed, login, logout };
    })();

    // ========== åŸºç¡€ç»„ä»¶ï¼šä¾§è¾¹æ ä¸é¡¶éƒ¨æ  ==========
    const Sidebar = {
      name: "Sidebar",
      // ç®€å•çš„å¯¼èˆªåˆ—è¡¨ï¼Œä½¿ç”¨ <router-link> è¿›è¡Œé¡µé¢è·³è½¬
      template: `
        <nav class="nav">
          <router-link to="/">ğŸ“Š ä»ªè¡¨ç›˜</router-link>
          <router-link to="/users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</router-link>
          <router-link to="/products">ğŸ›’ äº§å“ç®¡ç†</router-link>
          <router-link to="/settings">âš™ï¸ ç³»ç»Ÿè®¾ç½®</router-link>
        </nav>
      `
    };
    const Topbar = {
      name: "Topbar",
      setup(){
        const q = Vue.ref(""); // é¡¶éƒ¨æœç´¢è¾“å…¥ï¼Œä»…å±•ç¤ºç”¨
        function logout(){ store.logout(); }
        return { store, q, logout };
      },
      template: `
        <div class="space-between" style="width:100%">
          <div style="display:flex;gap:8px;align-items:center">
            <input class="input" style="width:240px" v-model="q" placeholder="æœç´¢..." />
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <!-- æ¨¡æ¿ä¸­ä¼šè‡ªåŠ¨è§£åŒ…refï¼Œè¿™é‡Œå±•ç¤ºå½“å‰ç”¨æˆ·åç§° -->
            <span v-if="store.currentUser" class="pill gray">{{ store.currentUser?.name || 'æ¸¸å®¢' }}</span>
            <router-link v-if="!store.currentUser" class="btn secondary" to="/login">ç™»å½•</router-link>
            <button v-else class="btn secondary" @click="logout">é€€å‡º</button>
          </div>
        </div>
      `
    };

    // ========== é¡µé¢ï¼šç™»å½• ==========
    const Login = {
      name: "Login",
      setup(){
        const username = Vue.ref("");   // è´¦å·
        const password = Vue.ref("");   // å¯†ç 
        const msg = Vue.ref("");        // é”™è¯¯æç¤º
        function submit(){
          const u = api.login({ username: username.value, password: password.value });
          if (!u){ msg.value = "è´¦å·æˆ–å¯†ç é”™è¯¯"; return; }
          store.login(u); msg.value = ""; location.hash = "#/"; // ä½¿ç”¨hashè·¯ç”±è·³è½¬åˆ°é¦–é¡µ
        }
        return { username, password, msg, submit };
      },
      template: `
        <div style="max-width:360px;margin:60px auto">
          <div class="card">
            <h2>ç™»å½•</h2>
            <div style="display:grid;gap:8px;margin-top:12px">
              <input class="input" v-model="username" placeholder="è´¦å· admin" />
              <input class="input" type="password" v-model="password" placeholder="å¯†ç  123456" />
              <button class="btn" @click="submit">ç™»å½•</button>
              <div v-if="msg" class="pill warn">{{ msg }}</div>
            </div>
          </div>
        </div>
      `
    };

    // ========== é¡µé¢ï¼šä»ªè¡¨ç›˜ ==========
    const Dashboard = {
      name: "Dashboard",
      setup(){
        const data = Vue.ref(api.stats()); // ç»Ÿè®¡æ•°æ®
        function refresh(){ data.value = api.stats(); }
        return { data, refresh };
      },
      template: `
        <div>
          <div class="space-between">
            <h2>ä»ªè¡¨ç›˜</h2>
            <button class="btn secondary" @click="refresh">åˆ·æ–°</button>
          </div>
          <div class="cards" style="margin-top:12px">
            <div class="card"><div>ç”¨æˆ·æ€»æ•°</div><div style="font-size:28px">{{ data.users }}</div></div>
            <div class="card"><div>äº§å“æ€»æ•°</div><div style="font-size:28px">{{ data.products }}</div></div>
            <div class="card"><div>åœ¨èŒç”¨æˆ·</div><div style="font-size:28px">{{ data.activeUsers }}</div></div>
            <div class="card"><div>ä¸Šæ¶äº§å“</div><div style="font-size:28px">{{ data.onSale }}</div></div>
          </div>
          <div class="card" style="margin-top:12px">
            <div class="space-between">
              <div>ä¼°ç®—è¿‘30å¤©æ”¶å…¥</div>
              <div style="font-size:28px">Â¥ {{ data.revenue }}</div>
            </div>
          </div>
        </div>
      `
    };

    // ========== é¡µé¢ï¼šç”¨æˆ·ç®¡ç†ï¼ˆCRUDï¼‰ ==========
    const Users = {
      name: "Users",
      setup(){
        const list = Vue.ref(api.listUsers());                                   // ç”¨æˆ·åˆ—è¡¨
        const q = Vue.ref("");                                                   // æœç´¢å…³é”®è¯
        const form = Vue.reactive({ name: "", email: "", role: "å®¢æœ", status: "åœ¨èŒ" }); // æ·»åŠ è¡¨å•
        const editing = Vue.ref(null);                                           // å½“å‰ç¼–è¾‘é¡¹
        function reload(){ list.value = api.listUsers(); }
        function add(){
          if (!form.name || !form.email) return;
          api.addUser({ name: form.name, email: form.email, role: form.role, status: form.status });
          form.name=""; form.email=""; form.role="å®¢æœ"; form.status="åœ¨èŒ"; reload();
        }
        function del(id){ api.deleteUser(id); reload(); }
        function edit(u){ editing.value = { ...u }; }
        function save(){
          if (!editing.value) return;
          api.updateUser(editing.value.id, editing.value);
          editing.value = null; reload();
        }
        // è®¡ç®—å±æ€§ï¼šæ ¹æ®å…³é”®è¯è¿‡æ»¤åˆ—è¡¨
        const filtered = Vue.computed(()=>{
          const s = q.value.trim().toLowerCase();
          if (!s) return list.value;
          return list.value.filter(x =>
            x.name.toLowerCase().includes(s) ||
            x.email.toLowerCase().includes(s) ||
            x.role.toLowerCase().includes(s)
          );
        });
        return { list, q, form, editing, filtered, add, del, edit, save };
      },
      template: `
        <div>
          <div class="space-between">
            <h2>ç”¨æˆ·ç®¡ç†</h2>
            <div class="toolbar"><input class="input" v-model="q" placeholder="æœç´¢å§“å/é‚®ç®±/è§’è‰²" /></div>
          </div>
          <div class="form">
            <input v-model="form.name" class="input" placeholder="å§“å" />
            <input v-model="form.email" class="input" placeholder="é‚®ç®±" />
            <select v-model="form.role" class="input"><option>ç®¡ç†å‘˜</option><option>è¿è¥</option><option>å®¢æœ</option></select>
            <select v-model="form.status" class="input"><option>åœ¨èŒ</option><option>ç¦»èŒ</option></select>
            <div class="full"><button class="btn" @click="add">æ·»åŠ ç”¨æˆ·</button></div>
          </div>
          <table class="table">
            <thead><tr><th>ID</th><th>å§“å</th><th>é‚®ç®±</th><th>è§’è‰²</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              <tr v-for="u in filtered" :key="u.id">
                <td>{{ u.id }}</td><td>{{ u.name }}</td><td>{{ u.email }}</td>
                <td><span class="pill gray">{{ u.role }}</span></td>
                <td><span :class="['pill', u.status==='åœ¨èŒ' ? 'green':'gray']">{{ u.status }}</span></td>
                <td>
                  <button class="btn secondary" @click="edit(u)">ç¼–è¾‘</button>
                  <button class="btn danger" style="margin-left:6px" @click="del(u.id)">åˆ é™¤</button>
                </td>
              </tr>
            </tbody>
          </table>
          <div v-if="editing" class="card" style="margin-top:12px">
            <h3>ç¼–è¾‘ç”¨æˆ·</h3>
            <div class="form">
              <input v-model="editing.name" class="input" />
              <input v-model="editing.email" class="input" />
              <select v-model="editing.role" class="input"><option>ç®¡ç†å‘˜</option><option>è¿è¥</option><option>å®¢æœ</option></select>
              <select v-model="editing.status" class="input"><option>åœ¨èŒ</option><option>ç¦»èŒ</option></select>
              <div class="full">
                <button class="btn success" @click="save">ä¿å­˜</button>
                <button class="btn secondary" style="margin-left:6px" @click="editing=null">å–æ¶ˆ</button>
              </div>
            </div>
          </div>
        </div>
      `
    };

    // ========== é¡µé¢ï¼šäº§å“ç®¡ç†ï¼ˆCRUDï¼‰ ==========
    const Products = {
      name: "Products",
      setup(){
        const list = Vue.ref(api.listProducts());                       // äº§å“åˆ—è¡¨
        const q = Vue.ref("");                                          // æœç´¢å…³é”®è¯
        const form = Vue.reactive({ name: "", price: 0, stock: 0, status: "ä¸Šæ¶" }); // æ·»åŠ è¡¨å•
        const editing = Vue.ref(null);                                  // å½“å‰ç¼–è¾‘é¡¹
        function reload(){ list.value = api.listProducts(); }
        function add(){
          if (!form.name) return;
          api.addProduct({ name: form.name, price: Number(form.price), stock: Number(form.stock), status: form.status });
          form.name=""; form.price=0; form.stock=0; form.status="ä¸Šæ¶"; reload();
        }
        function del(id){ api.deleteProduct(id); reload(); }
        function edit(p){ editing.value = { ...p }; }
        function save(){
          if (!editing.value) return;
          api.updateProduct(editing.value.id, { ...editing.value, price: Number(editing.value.price), stock: Number(editing.value.stock) });
          editing.value = null; reload();
        }
        const filtered = Vue.computed(()=>{
          const s = q.value.trim().toLowerCase();
          if (!s) return list.value;
          return list.value.filter(x =>
            x.name.toLowerCase().includes(s) ||
            String(x.id).includes(s) ||
            x.status.toLowerCase().includes(s)
          );
        });
        return { list, q, form, editing, filtered, add, del, edit, save };
      },
      template: `
        <div>
          <div class="space-between">
            <h2>äº§å“ç®¡ç†</h2>
            <div class="toolbar"><input class="input" v-model="q" placeholder="æœç´¢åç§°/ID/çŠ¶æ€" /></div>
          </div>
          <div class="form">
            <input v-model="form.name" class="input" placeholder="äº§å“åç§°" />
            <input v-model="form.price" type="number" class="input" placeholder="ä»·æ ¼" />
            <input v-model="form.stock" type="number" class="input" placeholder="åº“å­˜" />
            <select v-model="form.status" class="input"><option>ä¸Šæ¶</option><option>ä¸‹æ¶</option></select>
            <div class="full"><button class="btn" @click="add">æ·»åŠ äº§å“</button></div>
          </div>
          <table class="table">
            <thead><tr><th>ID</th><th>åç§°</th><th>ä»·æ ¼</th><th>åº“å­˜</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
              <tr v-for="p in filtered" :key="p.id">
                <td>{{ p.id }}</td><td>{{ p.name }}</td><td>Â¥ {{ p.price }}</td><td>{{ p.stock }}</td>
                <td><span class="pill gray">{{ p.status }}</span></td>
                <td>
                  <button class="btn secondary" @click="edit(p)">ç¼–è¾‘</button>
                  <button class="btn danger" style="margin-left:6px" @click="del(p.id)">åˆ é™¤</button>
                </td>
              </tr>
            </tbody>
          </table>
          <div v-if="editing" class="card" style="margin-top:12px">
            <h3>ç¼–è¾‘äº§å“</h3>
            <div class="form">
              <input v-model="editing.name" class="input" />
              <input v-model="editing.price" type="number" class="input" />
              <input v-model="editing.stock" type="number" class="input" />
              <select v-model="editing.status" class="input"><option>ä¸Šæ¶</option><option>ä¸‹æ¶</option></select>
              <div class="full">
                <button class="btn success" @click="save">ä¿å­˜</button>
                <button class="btn secondary" style="margin-left:6px" @click="editing=null">å–æ¶ˆ</button>
              </div>
            </div>
          </div>
        </div>
      `
    };

    // ========== é¡µé¢ï¼šç³»ç»Ÿè®¾ç½® ==========
    const Settings = {
      name: "Settings",
      setup(){
        const info = Vue.ref(api.stats()); // åŸºæœ¬ç»Ÿè®¡
        function reset(){ localStorage.clear(); location.reload(); } // é‡ç½®ç¤ºä¾‹æ•°æ®å¹¶åˆ·æ–°
        return { info, reset };
      },
      template: `
        <div>
          <h2>ç³»ç»Ÿè®¾ç½®</h2>
          <div class="card" style="margin-top:12px">
            <div>æ•°æ®ç»Ÿè®¡</div>
            <div style="margin-top:8px">ç”¨æˆ·ï¼š{{ info.users }}ï¼Œäº§å“ï¼š{{ info.products }}</div>
          </div>
          <div class="card" style="margin-top:12px">
            <div class="space-between">
              <div>é‡ç½®ç¤ºä¾‹æ•°æ®</div>
              <button class="btn danger" @click="reset">é‡ç½®</button>
            </div>
          </div>
        </div>
      `
    };

    // ========== è·¯ç”±ï¼šå®šä¹‰å„é¡µé¢è·¯å¾„ä¸è®¿é—®å®ˆå« ==========
    const routes = [
      { path: "/login", component: Login },
      { path: "/", component: Dashboard, meta: { requiresAuth: true } },
      { path: "/users", component: Users, meta: { requiresAuth: true } },
      { path: "/products", component: Products, meta: { requiresAuth: true } },
      { path: "/settings", component: Settings, meta: { requiresAuth: true } },
    ];
    const router = VueRouter.createRouter({
      history: VueRouter.createWebHashHistory(), // ä½¿ç”¨ hash è·¯ç”±ï¼Œé¿å…é™æ€æ–‡ä»¶ç¯å¢ƒä¸‹åˆ·æ–°404
      routes,
    });
    router.beforeEach((to)=>{
      // ç®€å•è·¯ç”±å®ˆå«ï¼šæœªç™»å½•æ—¶è®¿é—®å—ä¿æŠ¤é¡µé¢è·³è½¬ç™»å½•
      if (to.meta && to.meta.requiresAuth && !store.currentUser.value) return "/login";
      // å·²ç™»å½•æ—¶è®¿é—®ç™»å½•é¡µè·³è½¬é¦–é¡µ
      if (to.path === "/login" && store.currentUser.value) return "/";
    });

    // ========== åº”ç”¨æ ¹ç»„ä»¶ï¼šå¸ƒå±€ä¸å ä½ ==========
    const App = {
      name: "App",
      components: { Sidebar, Topbar },
      setup(){ return { store }; },
      template: `
        <div class="layout">
          <aside class="sidebar">
            <div class="brand"><span>ç®¡ç†ç³»ç»Ÿ</span></div>
            <Sidebar />
          </aside>
          <header class="topbar"><Topbar /></header>
          <main class="content">
            <!-- è·¯ç”±å ä½ï¼Œæ¸²æŸ“å½“å‰é¡µé¢ -->
            <router-view />
            <div class="footer">ç¤ºä¾‹é¡¹ç›® Â· é€‚åˆåˆå­¦è€… Â· Vue3</div>
          </main>
        </div>
      `
    };

    // ========== åˆ›å»ºå¹¶æŒ‚è½½åº”ç”¨ ==========
    const app = Vue.createApp(App);
    app.use(router);
    app.mount("#app");
  </script>
</body>
</html>
